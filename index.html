<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great Class Quest</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Open+Sans:wght@400;600;700&family=Lora:ital@0;1&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Audio Library -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Chart.js for progress graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚≠ê</text></svg>">
    
    <!-- Link to your external stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="flex flex-col h-screen" style="background: linear-gradient(to bottom, #F0F9FF 0%, #E0F2FE 50%, #D6F9E3 100%);">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-24 left-0 w-full z-50 px-4 pointer-events-none"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-sky-200 flex flex-col items-center justify-center z-[60] transition-opacity duration-500">
        <div class="relative w-48 h-48">
            <i class="fas fa-star star" style="left: 20%; animation-delay: 0s;"></i>
            <i class="fas fa-star star" style="left: 40%; animation-delay: -1.5s;"></i>
            <i class="fas fa-star star" style="left: 60%; animation-delay: -0.5s;"></i>
            <i class="fas fa-star star" style="left: 80%; animation-delay: -1s;"></i>
        </div>
        <div class="font-title text-3xl text-sky-800 mt-4">Loading...</div>
    </div>

    <!-- Login/Signup Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-500 hidden" style="background: linear-gradient(135deg, #a8e0ff 0%, #8ee3f8 100%);">
        
        <span class="floating-star" style="top: 10%; left: 10%; font-size: 3rem; animation-delay: 0s;">‚≠ê</span>
        <span class="floating-star" style="bottom: 15%; right: 5%; font-size: 2.5rem; animation-delay: -3s;">üèÜ</span>
        <span class="floating-star" style="top: 30%; right: 20%; font-size: 4rem; animation-delay: -1s;">üöÄ</span>
        <span class="floating-star" style="bottom: 5%; left: 25%; font-size: 2rem; animation-delay: -5s;">üí°</span>
        <span class="floating-star" style="top: 55%; left: 15%; font-size: 2.8rem; animation-delay: -2s;">üß†</span>
        <span class="floating-star" style="bottom: 30%; right: 25%; font-size: 3.5rem; animation-delay: -4s;">üé®</span>

        <div class="w-full max-w-md z-10">
            <h1 class="font-title text-5xl text-white text-center mb-6 wobbly-title login-title-pulse" style="text-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                The Great Class Quest
                <span class="block text-2xl text-white/80 font-semibold mt-1">Prodigies Language School</span>
            </h1>
            
            <div id="login-form-container" class="bg-white p-8 rounded-3xl shadow-2xl pop-in">
                <h2 id="auth-title" class="font-title text-3xl text-sky-700 text-center mb-6">Teacher Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-bold text-gray-700 mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="off" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="new-password" required>
                    </div>
                    <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-title text-xl py-3 rounded-xl bubbly-button">Login</button>
                </form>
                
                <form id="signup-form" class="hidden">
                    <div class="mb-4">
                        <label for="signup-name" class="block text-sm font-bold text-gray-700 mb-2">Your Name</label>
                        <input type="text" id="signup-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="off" required>
                    </div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-bold text-gray-700 mb-2">Email</Labe></label>
                        <input type="email" id="signup-email" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="off" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                        <input type="password" id="signup-password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="new-password" required>
                    </div>
                    <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-title text-xl py-3 rounded-xl bubbly-button">Sign Up</button>
                </form>
                
                <p id="auth-error" class="text-sm text-red-600 mt-4 text-center h-4"></p>
                <div class="text-center mt-4">
                    <button id="toggle-auth-mode" class="text-sm text-sky-600 hover:underline">Need an account? Sign Up</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App Screen -->
    <div id="app-screen" class="hidden flex-1 flex flex-col h-full overflow-hidden">
        
        <header class="relative overflow-hidden z-10 flex items-center justify-between p-4 shadow-md" style="background: linear-gradient(to right, #89f7fe 0%, #66a6ff 100%);">
            <div class="absolute inset-0 z-1">
                <i class="fas fa-cloud cloud" style="left: 10%; animation-delay: -5s;"></i>
                <i class="fas fa-cloud cloud cloud-fast" style="left: 30%; animation-delay: -15s; font-size: 6rem;"></i>
                <i class="fas fa-cloud cloud" style="left: 60%; animation-delay: -2s; font-size: 10rem;"></i>
                <i class="fas fa-cloud cloud cloud-fast" style="left: 80%; animation-delay: -25s;"></i>
            </div>
            
            <div class="z-10">
                <h1 class="font-title text-4xl text-white" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">The Great Class Quest</h1>
                <p id="teacher-greeting" class="text-white text-base opacity-90 font-bold">Welcome, Teacher!</p>
                <p class="text-white text-sm opacity-80 -mt-1">Prodigies Language School</p>
            </div>
            <div class="z-10 flex items-center space-x-4">
                 <div id="current-date-time" class="text-right text-white font-title opacity-95 date-bounce">
                    <div id="current-date" class="text-3xl font-bold"></div>
                    <div id="current-time" class="text-3xl pulse-subtle"></div>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full bubbly-button">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-6">
            
            <div id="about-tab" class="app-tab">
                <div class="max-w-6xl mx-auto text-center">
                    <div class="relative inline-block mb-6">
                        <i class="fas fa-star text-amber-400 text-5xl floating-icon absolute top-0 -left-16 title-sparkle" style="animation-delay: -1s;"></i>
                        <h2 class="font-title text-5xl md:text-6xl text-cyan-700 mb-4 inline-block" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            Your Epic Adventure Awaits!
                        </h2>
                        <i class="fas fa-trophy text-amber-400 text-5xl floating-icon absolute top-2 -right-16" style="animation-delay: -2.5s;"></i>
                    </div>

                    <div class="my-6">
                        <div class="inline-flex items-center justify-center gap-4">
                            <button id="about-btn-students" class="about-tab-switcher bg-cyan-500 text-white shadow-md">
                                <i class="fas fa-user-graduate mr-2"></i> For Students
                            </button>
                            <button id="about-btn-teachers" class="about-tab-switcher bg-white text-green-700">
                                <i class="fas fa-chalkboard-teacher mr-2"></i> For Teachers
                            </button>
                        </div>
                    </div>

                    <div id="about-students" class="about-content">
                        <div class="game-card border-cyan-300 text-left space-y-6 text-lg text-cyan-800">
                            <h3 class="font-title text-4xl text-cyan-700 text-center mb-6">Hello, Brave Adventurers!</h3>
                            <p class="text-center text-xl -mt-4 mb-6 leading-relaxed">Your mission, should you choose to accept it, is to embark on a quest for glory, teamwork, and <b>amazing prizes</b>. There are <b class="text-rose-600">two ways to win!</b> You can track your class's progress on the <b class="text-blue-600">Team Quest</b> tab and your own rank on the <b class="text-purple-600">Hero's Challenge</b> tab.</p>
                            
                            <div class="grid md:grid-cols-2 gap-8">
                                <!-- The Team Quest -->
                                <div class="bg-blue-50 p-8 rounded-2xl shadow-inner border-l-8 border-blue-500 space-y-4">
                                    <h4 class="font-title text-3xl text-blue-700 flex items-center gap-3"><i class="fas fa-route text-4xl"></i> The Team Quest</h4>
                                    <p class="leading-relaxed">Band together with your classmates! Your ultimate goal is to guide your class across the <b class="text-blue-600">Team Quest</b> map faster than any other team in your league. Every <b class="text-amber-600">Star of Excellence</b> <i class="fas fa-star text-amber-500"></i> your class earns helps you advance past milestones and race toward the finish line!</p>
                                    <div class="prize-box bg-gradient-to-br from-blue-500 to-cyan-400 text-white p-4 rounded-xl shadow-lg text-center">
                                        <p class="font-title text-2xl mb-1"><i class="fas fa-trophy mr-2"></i> Team Prize!</p>
                                        <p class="font-semibold">The class that travels furthest on the Quest Map each month wins a <b class="text-yellow-200">Special Lesson Experience</b>, chosen by your whole team!</p>
                                    </div>
                                </div>

                                <!-- The Hero's Challenge -->
                                <div class="bg-purple-50 p-8 rounded-2xl shadow-inner border-l-8 border-purple-500 space-y-4">
                                    <h4 class="font-title text-3xl text-purple-700 flex items-center gap-3"><i class="fas fa-user-shield text-4xl"></i> The Hero's Challenge</h4>
                                    <p class="leading-relaxed">The adventure doesn‚Äôt stop with your team! Every star you earn also counts for <b class="text-purple-600">YOU</b>. Compete against all other students in your class and even in your entire league to see who can collect the most stars.</p>
                                    <div class="prize-box bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-xl shadow-lg text-center">
                                        <p class="font-title text-2xl mb-1"><i class="fas fa-medal mr-2"></i> Hero Prize!</p>
                                        <p class="font-semibold">The student with the most stars in the entire league each month will be crowned the <b class="text-yellow-200">"Prodigy of the Month"</b> and win a special prize!</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-8 rounded-2xl shadow-inner border-l-8 border-green-500 mt-6">
                                <h4 class="font-title text-3xl text-green-700 text-center mb-4">How to Earn Stars <i class="fas fa-star text-amber-400"></i></h4>
                                <ul class="list-none space-y-3 leading-relaxed">
                                    <li class="flex items-start"><i class="fas fa-users text-purple-500 mr-3 mt-1 text-xl"></i><div><b class="text-purple-600">Teamwork:</b> This is all about being a <b>great teammate</b>! You can earn stars by <b>helping a friend</b> who is stuck, <b>sharing your ideas</b> kindly with the group, or working together to <b>solve a puzzle</b> as a team.</div></li>
                                    <li class="flex items-start"><i class="fas fa-lightbulb text-pink-500 mr-3 mt-1 text-xl"></i><div><b class="text-pink-600">Creativity:</b> Let your imagination shine! Earn stars by thinking of a <b>new or clever way</b> to do something, telling an <b>exciting and original story</b>, or using your English to make something <b>unique</b>.</div></li>
                                    <li class="flex items-start"><i class="fas fa-hands-helping text-green-500 mr-3 mt-1 text-xl"></i><div><b class="text-green-600">Respect:</b> Show everyone you are a <b>kind and thoughtful</b> adventurer. You earn stars by <b>listening carefully</b> when others are speaking, <b>raising your hand</b> to share your ideas, and always being <b>polite</b> with your words and actions.</div></li>
                                    <li class="flex items-start"><i class="fas fa-brain text-yellow-500 mr-3 mt-1 text-xl"></i><div><b class="text-yellow-600">Focus & Effort:</b> This star is for being a <b>hard worker</b>! Earn it by <b>trying your absolute best</b> on a task, staying on track without getting distracted, and <b>never giving up</b>, even when something is tricky.</div></li>
                                </ul>
                            </div>
                            <p class="text-center font-bold text-2xl text-gray-700 mt-4">Good luck, adventurers! Your quest begins now!</p>
                        </div>
                    </div>

                    <div id="about-teachers" class="about-content hidden">
                         <div class="game-card border-green-300 text-left space-y-6 text-lg text-green-800">
                            <h3 class="font-title text-4xl text-green-700 text-center mb-6">Welcome, Quest Facilitator!</h3>
                            
                            <div class="bg-green-50 p-6 rounded-xl shadow-inner border-l-4 border-green-500">
                                <p class="text-xl font-bold text-green-700 flex items-center mb-2"><i class="fas fa-bullseye mr-3 text-2xl"></i> App Purpose & Philosophy</p>
                                <p class="leading-relaxed">This tool is designed for <b>positive behavior reinforcement</b>. It gamifies classroom participation by focusing on two parallel competitions to engage students both <b>collectively</b> (as a class team) and <b>individually</b> (as heroes).</p>
                            </div>

                            <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border-l-4 border-indigo-500">
                                <p class="text-xl font-bold text-indigo-700 flex items-center mb-2"><i class="fas fa-compass mr-3 text-2xl"></i> Your Core Tools</p>
                                <ul class="list-disc list-inside space-y-2 leading-relaxed">
                                    <li><b class="text-indigo-700">Award Stars:</b> Use the <b>"Award"</b> tab to give stars for positive behaviors. Each star contributes to <b>both the class's Team Quest progress and the student's individual score</b>.</li>
                                    <li><b class="text-indigo-700">Monitor Progress:</b> Use the <b>"Team Quest"</b> tab to foster class unity and competition between classes. Use the <b>"Hero's Challenge"</b> tab to track individual leaders and encourage personal growth.</li>
                                    <li><b class="text-indigo-700">Chronicle Adventures:</b> After class, use the <b>"Adventure Log"</b> to generate a beautiful, AI-illustrated diary entry of the day's achievements. This creates a lasting, visual record of your class's journey.</li>
                                     <li><b class="text-indigo-700">Weave Stories Together:</b> Use the <b>"Story Weavers"</b> game in the <b>"Ideas"</b> tab to collaboratively build a story with your class, one sentence at a time. It's a fantastic tool for practicing sentence structure and vocabulary in a fun, creative context.</li>
                                    <li><b class="text-indigo-700">Plan and Schedule:</b> The <b>"Calendar"</b> automatically shows your class schedule and allows you to add special "Quest Events" like "2x Star Days" to boost engagement.</li>
                                </ul>
                            </div>
                            
                            <div class="bg-rose-50 p-6 rounded-xl shadow-inner border-l-4 border-rose-500">
                                <p class="text-xl font-bold text-rose-700 flex items-center mb-2"><i class="fas fa-cogs mr-3 text-2xl"></i> AI-Powered Assistance</p>
                                <p class="mt-2 space-y-2 leading-relaxed">
                                    <span class="block"><i class="fas fa-lightbulb text-amber-500 mr-2"></i> The <b>"The Treasure Chest"</b> in the "Ideas" tab helps you brainstorm fun, age-appropriate prizes for the winning class.</li>
                                    <span class="block"><i class="fas fa-question-circle text-purple-500 mr-2"></i> <b>"The Oracle's Insight"</b> analyzes your class's performance data to answer your questions, like "Which skill needs more focus?".</li>
                                    <span class="block"><i class="fas fa-scroll text-teal-500 mr-2"></i> The <b>"Get Quest Update"</b> button on the Team Quest tab generates an exciting, dramatic narrative about the class leaderboard race that you can read aloud.</li>
                                </p>
                            </div>

                            <div class="bg-amber-50 p-6 rounded-xl shadow-inner border-l-4 border-amber-500 mt-4">
                                <p class="text-xl font-bold text-amber-700 flex items-center mb-2"><i class="fas fa-star-of-life mr-3 text-2xl"></i> Management & Options</p>
                                <p class="leading-relaxed">The <b>"My Classes"</b> tab is your hub for creating classes and managing student rosters. In the <b>"Options"</b> tab, you can change your display name and use the powerful "Student Star Manager" to make manual corrections or add historical awards if needed.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

           <!-- Class Leaderboard Tab -->
            <div id="class-leaderboard-tab" class="app-tab hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-route text-amber-600 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-amber-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Team Quest</h2>
                        <p class="text-lg text-gray-600 mt-2">Race against other classes in your league toward the finish line!</p>
                    </div>

                    <!-- UNIFIED CONTROL CONTAINER -->
                    <div class="bg-white/70 backdrop-blur-sm p-4 rounded-2xl shadow-lg flex flex-col items-center justify-center mb-6 gap-4">
                        <!-- Row 1: League Picker & History -->
                        <div class="flex items-center gap-4">
                            <span class="font-title text-2xl text-amber-700">Quest League:</span>
                            <button id="leaderboard-league-picker-btn" class="font-title text-2xl bg-white text-amber-800 py-2 px-6 rounded-full shadow-lg border-4 border-amber-300 bubbly-button">
                                Select a League
                            </button>
                            <button id="class-history-btn" class="font-title text-xl bg-white text-amber-800 py-2 px-6 rounded-full shadow-lg border-4 border-amber-300 bubbly-button">
                                <i class="fas fa-history mr-2"></i>View History
                            </button>
                        </div>
                        <!-- Row 2: Action Buttons -->
                        <div class="flex items-center justify-center">
                            <button id="get-quest-update-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-title text-xl py-3 px-8 rounded-full bubbly-button shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-scroll mr-2"></i> Get Quest Update!
                            </button>
                        </div>
                    </div>
                    <div class="px-4 md:px-12">
                        <div id="class-leaderboard-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- Student Leaderboard Tab -->
            <div id="student-leaderboard-tab" class="app-tab hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-user-shield text-purple-600 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-purple-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Hero's Challenge</h2>
                        <p class="text-lg text-gray-600 mt-2">Rise through the ranks and become a legend!</p>
                    </div>
                    <!-- UNIFIED CONTROL CONTAINER -->
                    <div class="bg-white/70 backdrop-blur-sm p-4 rounded-2xl shadow-lg flex flex-col items-center justify-center mb-6 gap-4">
                        <!-- Row 1: League Picker & History -->
                        <div class="flex items-center gap-4">
                            <span class="font-title text-2xl text-purple-700">Quest League:</span>
                            <button id="student-leaderboard-league-picker-btn" class="font-title text-2xl bg-white text-purple-800 py-2 px-6 rounded-full shadow-lg border-4 border-purple-300 bubbly-button">
                                Select a League
                            </button>
                            <button id="student-history-btn" class="font-title text-xl bg-white text-purple-800 py-2 px-6 rounded-full shadow-lg border-4 border-purple-300 bubbly-button">
                                <i class="fas fa-history mr-2"></i>View History
                            </button>
                        </div>
                        <!-- Row 2: Action Buttons -->
                        <div id="student-view-switcher" class="flex flex-wrap items-center justify-center gap-2 sm:gap-4">
                            <div class="flex gap-2">
                                <button id="view-by-class" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-full bubbly-button">
                                    By Class
                                </button>
                                <button id="view-by-league" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full bubbly-button">
                                    Global Rank
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button id="metric-monthly" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-full bubbly-button">
                                    Monthly Stars
                                </button>
                                <button id="metric-total" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full bubbly-button">
                                    Total Stars
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="student-leaderboard-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- My Classes Tab -->
            <div id="my-classes-tab" class="app-tab hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-chalkboard-teacher text-green-600 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-green-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">My Classes</h2>
                        <p class="text-lg text-gray-600 mt-2">Create new classes and manage your student rosters.</p>
                    </div>
                    <form id="add-class-form" class="bg-white p-6 rounded-3xl shadow-lg border-4 border-green-300 mb-6">
                        <h2 class="font-title text-3xl text-green-700 mb-4 text-center">Create a New Class</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="class-name" class="block text-sm font-medium text-gray-700">Class Name (e.g., "The Star Seekers")</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="text" id="class-name" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" autocomplete="off" required>
                                    <button type="button" id="generate-class-name-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md bubbly-button disabled:opacity-50" title="Suggest names with AI">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                </div>
                                <div id="class-name-suggestions" class="mt-2 flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <label for="class-level" class="block text-sm font-medium text-gray-700">Quest Level (League)</label>
                                <select id="class-level" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                                    <option value="" disabled selected>Select a league...</option>
                                    <option>Junior A</option>
                                    <option>Junior B</option>
                                    <option>A</option>
                                    <option>B</option>
                                    <option>C</option>
                                    <option>D</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Class Logo</label>
                                    <button type="button" id="logo-picker-btn" class="bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 text-2xl bubbly-button">
                                        üìö
                                    </button>
                                    <input type="hidden" id="class-logo" value="üìö">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Schedule Days</label>
                                <div class="mt-2 flex flex-wrap gap-2">
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full"><input type="checkbox" name="schedule-day" value="1" class="rounded text-green-600"> <span>Mon</span></label>
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full"><input type="checkbox" name="schedule-day" value="2" class="rounded text-green-600"> <span>Tue</span></label>
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full"><input type="checkbox" name="schedule-day" value="3" class="rounded text-green-600"> <span>Wed</span></label>
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full"><input type="checkbox" name="schedule-day" value="4" class="rounded text-green-600"> <span>Thu</span></label>
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full"><input type="checkbox" name="schedule-day" value="5" class="rounded text-green-600"> <span>Fri</span></label>
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full"><input type="checkbox" name="schedule-day" value="6" class="rounded text-green-600"> <span>Sat</span></label>
                                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded-full"><input type="checkbox" name="schedule-day" value="0" class="rounded text-green-600"> <span>Sun</span></label>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div>
                                    <label for="class-time-start" class="block text-sm font-medium text-gray-700">From</label>
                                    <input type="time" id="class-time-start" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="class-time-end" class="block text-sm font-medium text-gray-700">To</label>
                                    <input type="time" id="class-time-end" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-title text-xl py-3 rounded-xl bubbly-button">
                            <i class="fas fa-plus-circle"></i> Create Class
                        </button>
                    </form>
                    <div id="class-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Manage Students Tab (Submenu) -->
            <div id="manage-students-tab" class="app-tab hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="flex items-center mb-6">
                        <button id="back-to-classes-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full bubbly-button">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <h2 class="font-title text-3xl text-teal-700 text-center flex-1">
                            Managing: <span id="manage-class-name"></span>
                        </h2>
                        <input type="hidden" id="manage-class-id">
                    </div>
                    
                    <div class="flex flex-col md:flex-row items-start gap-8">
                        <div class="w-full md:w-1/3 flex-shrink-0">
                            <form id="add-student-form" class="bg-white p-6 rounded-3xl shadow-lg border-4 border-teal-300">
                                <h3 class="font-title text-2xl text-teal-700 mb-4 text-center">Add New Student</h3>
                                <div class="mb-4">
                                    <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                                    <input type="text" id="student-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" autocomplete="off" required>
                                </div>
                                <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-title text-xl py-3 rounded-xl bubbly-button">
                                    <i class="fas fa-user-plus"></i> Add Student
                                </button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-lg border-4 border-teal-300 w-full flex-grow">
                             <h3 class="font-title text-2xl text-teal-700 mb-4 text-center">Student Roster</h3>
                            <div id="student-list" class="space-y-3 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Award Stars Tab -->
            <div id="award-stars-tab" class="app-tab hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-star text-rose-500 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-rose-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Award Stars</h2>
                        <p class="text-lg text-gray-600 mt-2">Recognize your students' excellence and effort.</p>
                    </div>
                    
                    <div id="award-class-dropdown" class="relative max-w-md mx-auto mb-6">
                        <button id="award-class-dropdown-btn" class="w-full flex items-center justify-between p-4 rounded-2xl border-4 border-rose-300 bg-white shadow-lg bubbly-button">
                            <span class="flex items-center gap-3">
                                <span id="selected-class-logo" class="text-4xl"></span>
                                <div class="text-left">
                                    <div id="selected-class-name" class="font-bold text-lg text-rose-800">Select a class...</div>
                                    <div id="selected-class-level" class="text-sm text-rose-500 -mt-1"></div>
                                </div>
                            </span>
                            <i class="fas fa-chevron-down text-rose-500 transition-transform"></i>
                        </button>
                        <div id="award-class-dropdown-panel" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-2xl z-20 hidden overflow-hidden border-2 border-rose-200">
                            <div id="award-class-list" class="max-h-64 overflow-y-auto">
                                <!-- Dropdown items will be injected here -->
                            </div>
                        </div>
                    </div>

                    <div id="award-stars-student-list" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <p class="text-center text-gray-700 bg-white/70 backdrop-blur-sm p-4 rounded-2xl text-lg col-span-full">Please select a class to award stars.</p>
                    </div>
                </div>
            </div>

            <!-- V5.5.0: ADVENTURE LOG TAB REVAMPED -->
            <div id="adventure-log-tab" class="app-tab hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-book-open text-teal-500 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-teal-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Adventure Log</h2>
                        <p class="text-lg text-gray-600 mt-2">A visual diary of your class's epic journey!</p>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-lg border-2 border-gray-100 flex flex-col gap-4 mb-6">
                        <div class="flex flex-col sm:flex-row items-center justify-start gap-4 w-full">
                            <select id="adventure-log-class-select" class="w-full sm:w-auto flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white text-lg">
                                <option value="">Select a class to view its log...</option>
                            </select>
                            <select id="adventure-log-month-filter" class="w-full sm:w-auto px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white text-lg"></select>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 w-full">
                            <button id="log-adventure-btn" class="w-full sm:w-auto bg-teal-500 hover:bg-teal-600 text-white font-title text-xl py-3 px-6 rounded-lg bubbly-button disabled:opacity-50" disabled>
                                <i class="fas fa-feather-alt mr-2"></i> Log Today's Adventure
                            </button>
                            <button id="quest-assignment-btn" class="w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-title text-xl py-3 px-6 rounded-lg bubbly-button disabled:opacity-50" disabled>
                                <i class="fas fa-scroll mr-2"></i> Quest Assignment
                            </button>
                            <button id="attendance-chronicle-btn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-title text-xl py-3 px-6 rounded-lg bubbly-button disabled:opacity-50" disabled>
                                <i class="fas fa-user-check mr-2"></i> Attendance
                            </button>
                        </div>
                    </div>

                    <div id="adventure-log-feed" class="space-y-6 max-h-[60vh] overflow-y-auto p-2">
                        <!-- Log entries will be injected here -->
                    </div>
                </div>
            </div>

            <!-- NEW in v6.0.0: Scholar's Scroll Tab -->
            <div id="scholars-scroll-tab" class="app-tab hidden">
                <div class="max-w-6xl mx-auto">
    <div class="text-center mb-6">
        <i class="fas fa-scroll text-amber-800 text-5xl floating-icon" style="animation-delay: -1s;"></i>
        <h2 class="font-title text-5xl text-amber-800 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">The Scholar's Scroll</h2>
        <p class="text-lg text-gray-600 mt-2">Chronicle the Trials of Knowledge and celebrate academic triumphs!</p>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow-lg border-2 border-gray-100 flex flex-col sm:flex-row items-center gap-4 mb-6">
        <select id="scroll-class-select" class="w-full sm:w-auto flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white text-lg">
            <option value="">Select a class to view their scroll...</option>
        </select>
        <button id="log-trial-btn" class="w-full sm:w-auto bg-amber-700 hover:bg-amber-800 text-white font-title text-xl py-3 px-6 rounded-lg bubbly-button disabled:opacity-50" disabled>
            <i class="fas fa-feather-alt mr-2"></i> Log a New Trial
        </button>
        <button id="view-trial-history-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-title text-xl py-3 px-6 rounded-lg bubbly-button disabled:opacity-50" disabled>
            <i class="fas fa-history mr-2"></i> View History
        </button>
    </div>

    <div id="scroll-dashboard-content" class="hidden">
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" id="scroll-stats-cards">
            <!-- Stat cards will be injected here -->
        </div>
        
        <!-- Performance Chart -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h3 class="font-title text-2xl text-gray-700 mb-4">Class Performance Chart</h3>
            <div id="scroll-performance-chart" class="space-y-3">
                <!-- Chart will be injected here -->
            </div>
        </div>
    </div>
    <div id="scroll-placeholder" class="text-center text-gray-500 bg-white/50 p-6 rounded-2xl">
        Please select a class to view their academic progress.
    </div>
</div>
</div>

            <!-- Calendar Tab -->
            <div id="calendar-tab" class="app-tab hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-calendar-alt text-blue-600 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-blue-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Quest Calendar</h2>
                        <p class="text-lg text-gray-600 mt-2">View your schedule and plan special Quest Events.</p>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-4 p-4 bg-white/70 rounded-2xl shadow-lg backdrop-blur-sm">
                            <button id="prev-month-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold w-12 h-12 rounded-full bubbly-button">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h2 id="calendar-month-year" class="font-title text-3xl text-blue-700 text-center"></h2>
                            <button id="next-month-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold w-12 h-12 rounded-full bubbly-button">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 p-4 bg-white/70 rounded-2xl shadow-lg backdrop-blur-sm">
                            <!-- ADD THIS SPINNER HTML -->
<div id="calendar-loader" class="hidden absolute inset-0 bg-white/50 backdrop-blur-sm flex-col items-center justify-center z-10 rounded-2xl">
    <i class="fas fa-star text-amber-500 text-5xl animate-spin"></i>
    <p class="font-title text-xl text-amber-700 mt-4">Fetching Quest Logs...</p>
 </div>
                            <div class="text-center font-bold text-gray-600">Mon</div>
                            <div class="text-center font-bold text-gray-600">Tue</div>
                            <div class="text-center font-bold text-gray-600">Wed</div>
                            <div class="text-center font-bold text-gray-600">Thu</div>
                            <div class="text-center font-bold text-gray-600">Fri</div>
                            <div class="text-center font-bold text-gray-600">Sat</div>
                            <div class="text-center font-bold text-gray-600">Sun</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reward Ideas Tab -->
            <div id="reward-ideas-tab" class="app-tab hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="text-center mb-6">
                        <i class="fas fa-magic text-indigo-500 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-indigo-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Idea Forge</h2>
                        <p class="text-lg text-gray-600 mt-2">Brainstorm rewards, analyze performance, and play creative games.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- The Treasure Chest -->
                        <div class="flex-1 bg-white p-6 rounded-3xl shadow-lg border-4 border-indigo-300 space-y-4">
                            <h2 class="font-title text-3xl text-indigo-700 mb-2 text-center flex items-center justify-center gap-2"><i class="fas fa-gem"></i> The Treasure Chest</h2>
                            <div class="mb-4">
                                <label for="gemini-class-select" class="block text-sm font-medium text-gray-700 mb-1">Select class for age group:</label>
                                <select id="gemini-class-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                                    <option value="">Select a class...</option>
                                </select>
                            </div>
                            <button id="gemini-idea-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-title text-xl py-3 rounded-xl bubbly-button disabled:opacity-50" disabled>
                                <i class="fas fa-lightbulb mr-2"></i> Generate New Idea
                            </button>
                            <div class="mt-4">
                                <textarea id="gemini-idea-output" class="w-full h-48 p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-inner" placeholder="AI-generated reward ideas will appear here..." readonly></textarea>
                                <button id="copy-idea-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg bubbly-button opacity-50" disabled>
                                    <i class="fas fa-copy"></i> Copy Idea
                                </button>
                            </div>
                        </div>
                        
                        <!-- The Oracle's Insight -->
                        <div class="flex-1 bg-white p-6 rounded-3xl shadow-lg border-4 border-purple-300 space-y-4">
                            <h2 class="font-title text-3xl text-purple-700 mb-2 text-center flex items-center justify-center gap-2"><i class="fa-solid fa-eye"></i> The Oracle's Insight</h2>
                            <p class="text-sm text-center text-gray-600 -mt-2 mb-4">Ask the AI about your class's performance!</p>
                            <div class="mb-4">
                                <label for="oracle-class-select" class="block text-sm font-medium text-gray-700 mb-1">Select a class to analyze:</label>
                                <select id="oracle-class-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                                    <option value="">Select a class...</option>
                                </select>
                            </div>
                            <div>
                                <label for="oracle-question-input" class="block text-sm font-medium text-gray-700 mb-1">Your Question:</label>
                                <input type="text" id="oracle-question-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., Which skill needs more focus?" autocomplete="off">
                            </div>
                            <button id="oracle-insight-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-title text-xl py-3 rounded-xl bubbly-button disabled:opacity-50" disabled>
                                <i class="fas fa-question-circle mr-2"></i> Ask the Oracle
                            </button>
                            <div class="mt-4">
                                <textarea id="oracle-insight-output" class="w-full h-48 p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-inner" placeholder="The Oracle's insights will appear here..." readonly></textarea>
                            </div>
                        </div>

                        <!-- v5.5.4 The Story Weavers Revamped -->
                        <div class="flex-1 bg-white p-6 rounded-3xl shadow-lg border-4 border-cyan-300 space-y-4 flex flex-col">
                            <h2 class="font-title text-3xl text-cyan-700 mb-2 text-center flex items-center justify-center gap-2"><i class="fas fa-feather-alt"></i> The Story Weavers</h2>
                            
                            <div class="mb-2">
                                <label for="story-weavers-class-select" class="block text-sm font-medium text-gray-700 mb-1">Select class to play:</label>
                                <select id="story-weavers-class-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white">
                                    <option value="">Select a class...</option>
                                </select>
                            </div>

                            <div id="story-weavers-main-content" class="hidden flex-grow flex flex-col">
                                <!-- Current Chapter Display -->
                                <div class="flex-grow flex flex-col items-center justify-center text-center">
                                    <div id="story-weavers-image-container">
                                        <img id="story-weavers-image" src="" alt="Story illustration" class="hidden pop-in">
                                        <div id="story-weavers-image-loader" class="text-gray-400 text-center hidden">
                                            <i class="fas fa-paint-brush fa-spin text-3xl"></i>
                                            <p class="text-sm mt-2">The Chronicler is illustrating...</p>
                                        </div>
                                        <div id="story-weavers-image-placeholder" class="text-gray-400 text-center">
                                            <i class="fas fa-book-reader text-4xl"></i>
                                            <p class="text-sm mt-2">The story awaits its illustration!</p>
                                        </div>
                                    </div>
                                    <p id="story-weavers-text" class="w-full p-2 max-h-28 overflow-y-auto"></p>
                                    <button id="story-weavers-reveal-btn" class="mt-2 text-sm text-cyan-600 hover:underline"><i class="fas fa-eye"></i> Reveal Story to Class</button>
                                </div>

                                <!-- Teacher Controls -->
                                <div class="mt-4 pt-4 border-t-2 border-gray-200">
                                    <h3 class="font-bold text-gray-600 text-center mb-2">Game Master's Desk</h3>
                                    <div class="flex items-center gap-2 mb-3">
                                        <input type="text" id="story-weavers-word-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm transition-colors" placeholder="Today's Word of the Day..." autocomplete="off">
                                        <button id="story-weavers-confirm-word-btn" class="bg-green-200 text-green-700 w-10 h-10 rounded-full bubbly-button flex-shrink-0 hidden" title="Lock in word"><i class="fas fa-check"></i></button>
                                        <button id="story-weavers-clear-word-btn" class="bg-red-200 text-red-700 w-10 h-10 rounded-full bubbly-button flex-shrink-0 hidden" title="Clear word"><i class="fas fa-times"></i></button>
                                        <button id="story-weavers-suggest-word-btn" class="bg-indigo-200 text-indigo-700 w-10 h-10 rounded-full bubbly-button flex-shrink-0" title="Suggest a word with AI"><i class="fas fa-magic"></i></button>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="story-weavers-lock-in-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-title text-lg py-2 rounded-xl bubbly-button disabled:opacity-50 disabled:cursor-not-allowed">
                                            Continue...
                                        </button>
                                        <button id="story-weavers-end-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-title text-lg py-2 rounded-xl bubbly-button disabled:opacity-50">
                                            The End
                                        </button>
                                    </div>
                                    <div class="flex justify-between mt-3">
                                        <button id="story-weavers-history-btn" class="text-sm text-gray-500 hover:underline"><i class="fas fa-scroll"></i> Current Story</button>
                                        <button id="story-weavers-archive-btn" class="text-sm text-indigo-500 hover:underline"><i class="fas fa-book-dead"></i> Story Archive</button>
                                        <button id="story-weavers-reset-btn" class="text-sm text-red-500 hover:underline"><i class="fas fa-undo"></i> Start New</button>
                                    </div>
                                </div>
                            </div>
                            <div id="story-weavers-placeholder" class="flex-grow flex items-center justify-center">
                                <p class="text-center text-gray-500">Select a class to begin your chronicle!</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <!-- CHANGE 3: Restructured Options Tab -->
            <div id="options-tab" class="app-tab hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <i class="fas fa-cog text-gray-600 text-5xl floating-icon"></i>
                        <h2 class="font-title text-5xl text-gray-700 mt-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Options & Settings</h2>
                        <p class="text-lg text-gray-600 mt-2">Manage your profile and access advanced tools.</p>
                    </div>
            
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                        <!-- Left Column: Star Manager -->
                        <div class="lg:col-span-3 bg-white p-6 rounded-3xl shadow-lg border-4 border-amber-300 space-y-6">
                            <h2 class="font-title text-3xl text-amber-700 mb-2 text-center">Student Star Manager</h2>
                            <div id="star-manager-form" class="space-y-4">
                                <div>
                                    <label for="star-manager-student-select" class="block text-sm font-medium text-gray-700 mb-1">Select Student</label>
                                    <select id="star-manager-student-select" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white">
                                        <option value="">Loading students...</option>
                                    </select>
                                </div>
                                <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                    <h3 class="font-title text-xl text-amber-800 mb-2 text-center">Add Historical Award</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="star-manager-date" class="block text-sm font-medium text-gray-700">Award Date</label>
                                            <input type="date" id="star-manager-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500" disabled>
                                        </div>
                                        <div>
                                            <label for="star-manager-stars-to-add" class="block text-sm font-medium text-gray-700">Stars to Add</label>
                                            <input type="number" id="star-manager-stars-to-add" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500" min="0.5" step="0.5" max="10" value="1" disabled>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="star-manager-reason" class="block text-sm font-medium text-gray-700 mt-2">Reason</label>
                                        <select id="star-manager-reason" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-amber-500" disabled>
                                            <option value="teamwork">Teamwork</option>
                                            <option value="creativity">Creativity</option>
                                            <option value="respect">Respect</option>
                                            <option value="focus">Focus/Effort</option>
                                            <option value="welcome_back">Welcome Back Bonus</option>
                                            <option value="correction">Manual Correction</option>
                                        </select>
                                    </div>
                                    <button id="star-manager-add-btn" class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-white font-title text-lg py-2 rounded-xl bubbly-button" disabled>
                                        <i class="fas fa-plus-circle mr-2"></i> Add Stars to Log
                                    </button>
                                </div>
                                <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                    <h3 class="font-title text-xl text-blue-800 mb-2 text-center">Direct Score Override</h3>
                                    <p class="text-xs text-gray-600 text-center mb-3">Manually set the star counters. This does NOT create a log entry.</p>
                                    <div id="star-override-form" class="grid grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label for="override-today-stars" class="block text-sm font-medium text-gray-700">Today</label>
                                            <input type="number" id="override-today-stars" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" min="0" value="0" disabled>
                                        </div>
                                        <div>
                                            <label for="override-monthly-stars" class="block text-sm font-medium text-gray-700">Monthly</label>
                                            <input type="number" id="override-monthly-stars" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" min="0" value="0" disabled>
                                        </div>
                                        <div>
                                            <label for="override-total-stars" class="block text-sm font-medium text-gray-700">Total</label>
                                            <input type="number" id="override-total-stars" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" min="0" value="0" disabled>
                                        </div>
                                    </div>
                                    <button id="star-manager-override-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-title text-lg py-2 rounded-xl bubbly-button" disabled>
                                        <i class="fas fa-wrench mr-2"></i> Set Student Scores
                                    </button>
                                </div>
                            </div>
                        </div>
            
                        <!-- Right Column: Profile & Danger Zone -->
                        <div class="lg:col-span-2 flex flex-col gap-8">
                            <!-- School Year Planner -->
<div class="bg-white p-6 rounded-3xl shadow-lg border-4 border-pink-300 space-y-4">
    <h2 class="font-title text-3xl text-pink-700 text-center">School Year Planner</h2>
    <p class="text-sm text-gray-500 text-center">Set school-wide holidays (Christmas, Easter) to overshadow the calendar.</p>
    
    <div class="grid grid-cols-2 gap-2">
        <div class="col-span-2">
            <label class="block text-xs font-bold text-gray-500">Holiday Name</label>
            <input type="text" id="holiday-name" placeholder="e.g. Christmas Break" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div>
            <label class="block text-xs font-bold text-gray-500">Start Date</label>
            <input type="date" id="holiday-start" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div>
            <label class="block text-xs font-bold text-gray-500">End Date</label>
            <input type="date" id="holiday-end" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="col-span-2">
            <label class="block text-xs font-bold text-gray-500">Theme</label>
            <select id="holiday-type" class="w-full px-3 py-2 border rounded-lg bg-white">
                <option value="christmas">üéÑ Christmas / Winter</option>
                <option value="easter">üê£ Easter / Spring</option>
                <option value="generic">üìÖ Generic / Other</option>
            </select>
        </div>
    </div>
    <button id="add-holiday-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 rounded-xl bubbly-button">
        <i class="fas fa-plus-circle mr-2"></i> Add Break
    </button>
    
    <div id="holiday-list" class="mt-4 space-y-2 max-h-40 overflow-y-auto">
        <!-- List populated by JS -->
    </div>
</div>
                            <!-- Profile Settings Card -->
                            <div class="bg-white p-6 rounded-3xl shadow-lg border-4 border-blue-300 space-y-4">
                                <h2 class="font-title text-3xl text-blue-700 text-center">Profile Settings</h2>
                                <div>
                                    <label for="teacher-name-input" class="block text-sm font-medium text-gray-700 mb-1">Your Display Name</label>
                                    <input type="text" id="teacher-name-input" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                                </div>
                                <button id="save-teacher-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-title text-xl py-3 rounded-xl bubbly-button flex items-center justify-center">
                                    <i class="fas fa-save mr-2"></i> Save Name
                                </button>
                            </div>
            
                            <!-- Danger Zone Card -->
                            <div class="bg-white p-6 rounded-3xl shadow-lg border-4 border-red-300 space-y-4">
                                <h2 class="font-title text-3xl text-red-700 text-center">Danger Zone</h2>
                                <div class="space-y-4">
                                    <p class="text-sm text-gray-600 text-center">These actions are permanent and can result in data loss. Proceed with caution.</p>
                                    <button id="star-manager-purge-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-title text-lg py-2 rounded-xl bubbly-button" disabled>
                                        <i class="fas fa-exclamation-triangle mr-2"></i> Purge Student Score Data
                                    </button>
                                    <button id="erase-today-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-title text-lg py-2 rounded-xl bubbly-button">
                                        <i class="fas fa-undo mr-2"></i> Erase Today's Stars
                                    </button>
                                    <button id="purge-logs-btn" class="w-full bg-red-800 hover:bg-red-900 text-white font-title text-lg py-2 rounded-xl bubbly-button">
                                        <i class="fas fa-fire mr-2"></i> Purge All My Award Logs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <nav id="bottom-nav-bar" class="grid grid-cols-10 gap-1 p-2 shadow-inner" style="background: linear-gradient(to right, #89f7fe 0%, #66a6ff 100%);">
            <button class="nav-button nav-color-cyan active" data-tab="about-tab">
                <i class="fas fa-home icon"></i>
                <span class="text">Home</span>
            </button>
            <button class="nav-button nav-color-amber" data-tab="class-leaderboard-tab">
                <i class="fas fa-route icon"></i>
                <span class="text">Team Quest</span>
            </button>
            <button class="nav-button nav-color-purple" data-tab="student-leaderboard-tab">
                <i class="fas fa-user-graduate icon"></i>
                <span class="text">Hero's Challenge</span>
            </button>
            <button class="nav-button nav-color-green" data-tab="my-classes-tab">
                <i class="fas fa-chalkboard-teacher icon"></i>
                <span class="text">My Classes</span>
            </button>
            <button class="nav-button nav-color-rose" data-tab="award-stars-tab">
                <i class="fas fa-star icon"></i>
                <span class="text">Award</span>
            </button>
            <button class="nav-button nav-color-teal" data-tab="adventure-log-tab">
                <i class="fas fa-book-open icon"></i>
                <span class="text">Log</span>
            </button>
            <button class="nav-button nav-color-scroll" data-tab="scholars-scroll-tab">
                <i class="fas fa-scroll icon"></i>
                <span class="text">Scroll</span>
            </button>
            <button class="nav-button nav-color-blue" data-tab="calendar-tab">
                <i class="fas fa-calendar-alt icon"></i>
                <span class="text">Calendar</span>
            </button>
            <button class="nav-button nav-color-indigo" data-tab="reward-ideas-tab">
                <i class="fas fa-magic icon"></i>
                <span class="text">Ideas</span>
            </button>
            <button class="nav-button nav-color-gray" data-tab="options-tab">
                <i class="fas fa-cog icon"></i>
                <span class="text">Options</span>
            </button>
            
            <button class="nav-tab hidden" data-tab="manage-students-tab"></button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full pop-in border-4 border-red-300">
            <h2 id="modal-title" class="font-title text-2xl text-red-700 mb-4 text-center">Are you sure?</h2>
            <p id="modal-message" class="text-center text-gray-700 mb-6">This action cannot be undone.</p>
            <div class="flex justify-around">
                <button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 px-8 rounded-xl bubbly-button">
                    Cancel
                </button>
                <button id="modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-title text-lg py-2 px-8 rounded-xl bubbly-button">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <div id="league-picker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full pop-in border-4 border-amber-300">
            <h2 class="font-title text-3xl text-amber-700 mb-6 text-center">Choose a League</h2>
            <div id="league-picker-list" class="grid grid-cols-2 gap-4"></div>
            <button id="league-picker-close-btn" class="w-full mt-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 rounded-xl bubbly-button">
                Close
            </button>
        </div>
    </div>
    
    <div id="logo-picker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-3xl w-full pop-in border-4 border-green-300">
            <h2 class="font-title text-3xl text-green-700 mb-6 text-center">Choose a Class Logo</h2>
            <div id="logo-picker-list" class="grid grid-cols-10 gap-4 text-3xl max-h-72 overflow-y-auto p-2"></div>
            <button id="logo-picker-close-btn" class="w-full mt-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 rounded-xl bubbly-button">
                Close
            </button>
        </div>
    </div>
    
    <div id="edit-class-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden overflow-y-auto">
        <form id="edit-class-form" class="bg-white p-8 rounded-3xl shadow-2xl max-w-lg w-full pop-in border-4 border-cyan-300 my-8">
            <h2 class="font-title text-3xl text-cyan-700 mb-6 text-center">Edit Class</h2>
            <input type="hidden" id="edit-class-id">
            
            <div class="space-y-4">
                <div>
                    <label for="edit-class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
                    <input type="text" id="edit-class-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" required>
                </div>
                <div>
                    <label for="edit-class-level" class="block text-sm font-medium text-gray-700">Quest Level</label>
                    <select id="edit-class-level" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" required></select>
                </div>
                <div>
                     <label class="block text-sm font-medium text-gray-700 mb-1">Class Logo</label>
                     <button type="button" id="edit-logo-picker-btn" class="bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 text-2xl bubbly-button"></button>
                     <input type="hidden" id="edit-class-logo">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Schedule Days</label>
                    <div id="edit-schedule-days" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                <div class="flex items-center gap-4">
                    <div>
                        <label for="edit-class-time-start" class="block text-sm font-medium text-gray-700">From</label>
                        <input type="time" id="edit-class-time-start" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="edit-class-time-end" class="block text-sm font-medium text-gray-700">To</label>
                        <input type="time" id="edit-class-time-end" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-6">
                 <button type="button" id="edit-class-cancel-btn" class="w-1/2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-3 rounded-xl bubbly-button">
                    Cancel
                </button>
                <button type="submit" class="w-1/2 bg-cyan-500 hover:bg-cyan-600 text-white font-title text-lg py-3 rounded-xl bubbly-button">
                    Save Changes
                </button>
            </div>
        </form>
    </div>

    <div id="logbook-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-3xl w-full pop-in border-4 border-blue-300">
            <div class="flex justify-between items-center mb-4">
                <h2 id="logbook-modal-title" class="font-title text-2xl md:text-3xl text-blue-700">Daily Quest Log</h2>
                <button id="logbook-modal-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="logbook-modal-content" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-4xl w-full pop-in border-4 border-amber-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-title text-2xl md:text-3xl text-amber-700">Historical Leaderboard</h2>
                <button id="history-modal-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div class="mb-4">
                <label for="history-month-select" class="block text-sm font-medium text-gray-700 mb-1">Select a past month:</label>
                <select id="history-month-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white">
                    <option value="">--Choose a month--</option>
                </select>
            </div>
            <div id="history-modal-content" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 bg-gray-50 p-4 rounded-lg">
                <p class="text-center text-gray-500">Select a month to view historical rankings.</p>
            </div>
        </div>
    </div>
    
    <!-- UNIFIED MODAL: Day Planner -->
    <div id="day-planner-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-lg w-full pop-in border-4 border-gray-300">
            <div class="flex justify-between items-center mb-4">
                <h2 id="day-planner-title" class="font-title text-3xl text-gray-700">Day Planner</h2>
                <button id="day-planner-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>

            <!-- Modal Tabs -->
            <div class="border-b border-gray-200 mb-4">
                <nav id="day-planner-tabs" class="-mb-px flex space-x-6">
                    <button data-tab="schedule" class="day-planner-tab-btn whitespace-nowrap py-3 px-1 border-b-4 font-semibold text-lg">
                        <i class="fas fa-calendar-day mr-2"></i>Schedule
                    </button>
                    <button data-tab="event" class="day-planner-tab-btn whitespace-nowrap py-3 px-1 border-b-4 font-semibold text-lg">
                        <i class="fas fa-magic mr-2"></i>Quest Event
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="day-planner-content">
                <!-- Schedule Tab Content -->
                <div id="day-planner-schedule-content" class="day-planner-tab-content">
                    <div id="schedule-manager-list" class="space-y-3 max-h-60 overflow-y-auto pr-2 mb-4">
                        <!-- JS will inject scheduled classes here -->
                    </div>
                    <div class="border-t pt-4">
                        <label for="add-onetime-lesson-select" class="block text-sm font-medium text-gray-700 mb-1">Add a one-time lesson:</label>
                        <div class="flex gap-2">
                            <select id="add-onetime-lesson-select" class="flex-grow mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500"></select>
                            <button id="add-onetime-lesson-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md bubbly-button">Add</button>
                        </div>
                    </div>
                </div>

                <!-- Event Tab Content -->
                <div id="day-planner-event-content" class="day-planner-tab-content hidden">
                    <form id="quest-event-form" class="space-y-4">
                        <input type="hidden" id="quest-event-date">
                        <div>
                            <label for="quest-event-type" class="block text-sm font-medium text-gray-700">Event Type</label>
                            <select id="quest-event-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-purple-500" required>
                                <option value="" disabled selected>Select an event type...</option>
                                <optgroup label="Standard Events">
                                    <option value="2x Star Day">2x Star Day</option>
                                    <option value="Reason Bonus Day">Reason Bonus Day</option>
                                </optgroup>
                                <optgroup label="Special Quests">
                                    <option value="Vocabulary Vault" data-description="Challenge the class to use a set of new vocabulary words a target number of times.">Vocabulary Vault</option>
                                    <option value="The Unbroken Chain" data-description="Challenge each student to speak about a topic for a short time without hesitation or repetition.">The Unbroken Chain</option>
                                    <option value="Grammar Guardians" data-description="Present sentences with grammatical errors and have the class work together to 'rescue' them by finding the corrections.">Grammar Guardians</option>
                                    <option value="The Scribe's Sketch" data-description="Describe a scene piece by piece and have students draw what they hear to test listening comprehension.">The Scribe's Sketch</option>
                                    <option value="Five-Sentence Saga" data-description="Give the class three elements (a character, location, object) and challenge them to write a coherent five-sentence story.">Five-Sentence Saga</option>
                                </optgroup>
                            </select>
                        </div>
                        <div id="quest-event-description" class="hidden text-sm text-gray-600 bg-purple-50 p-3 rounded-md border-l-4 border-purple-200"></div>
                        <div id="quest-event-details-container" class="space-y-4"></div>
                        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-title text-lg py-3 rounded-xl bubbly-button">
                            Add Event
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-2xl w-full pop-in border-4 border-green-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-title text-2xl md:text-3xl text-green-700">Weekly Quest Report</h2>
                <button id="report-modal-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="report-modal-content" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2 bg-green-50 p-4 rounded-lg"></div>
        </div>
    </div>
    
    <div id="certificate-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-2xl w-full pop-in border-4 border-indigo-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-title text-2xl md:text-3xl text-indigo-700">Certificate of Achievement</h2>
                <button id="certificate-modal-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="certificate-modal-content" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2 bg-indigo-50 p-4 rounded-lg"></div>
            <button id="download-certificate-btn" class="w-full mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-title text-lg py-3 rounded-xl bubbly-button hidden">
                <i class="fas fa-download mr-2"></i> Download as PDF
            </button>
        </div>
    </div>
    
    <!-- V4.0 NEW MODAL: Quest Update Narrative -->
    <div id="quest-update-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-2xl w-full pop-in border-4 border-purple-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-title text-2xl md:text-3xl text-purple-700">Latest Quest Update</h2>
                <button id="quest-update-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="narrative-text-container" class="mb-6 flex items-center justify-center">
                <!-- Content will be populated by JS -->
                <i class="fas fa-spinner fa-spin text-4xl text-purple-400"></i>
            </div>
            <button id="play-narrative-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-title text-2xl py-4 rounded-xl bubbly-button shadow-lg hidden">
                <i class="fas fa-play-circle mr-3"></i> Play Narrative
            </button>
        </div>
    </div>

    <!-- V5.3.1 REVAMPED MODAL: Milestone Details -->
    <div id="milestone-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-4xl w-full pop-in border-4 border-blue-300">
            <div class="flex justify-between items-center mb-4">
                <h2 id="milestone-modal-title" class="font-title text-2xl md:text-3xl text-blue-700">Milestone Progress</h2>
                <button id="milestone-modal-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="milestone-modal-content" class="space-y-4 text-center">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- V5.4.7 NEW MODAL: Welcome Back -->
    <div id="welcome-back-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="relative bg-gradient-to-br from-sky-300 to-lime-300 p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-4 border-white overflow-hidden">
            <!-- Animated decorations -->
            <span class="absolute text-4xl top-4 left-4 animate-ping opacity-50">‚ú®</span>
            <span class="absolute text-3xl bottom-8 right-8 animate-pulse">üéâ</span>
            <span class="absolute text-2xl top-12 right-12 animate-bounce">üëã</span>
            
            <div id="welcome-back-content" class="relative z-10 pop-in space-y-4">
                <h2 id="welcome-back-title" class="font-title text-4xl text-white" style="text-shadow: 0 2px 4px rgba(0,0,0,0.2);">Welcome Back!</h2>
                <p id="welcome-back-message" class="text-xl font-semibold text-gray-800 leading-relaxed"></p>
                <div class="inline-block bg-white/50 rounded-full p-4">
                    <p class="font-title text-5xl text-amber-600 flex items-center justify-center gap-2">
                        <i class="fas fa-star"></i>
                        <span id="welcome-back-stars">3</span>
                    </p>
                    <p class="text-sm font-bold text-amber-800 -mt-1">Bonus Stars!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- v5.2 NEW MODAL: Story Reveal -->
    <div id="story-reveal-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-4xl w-full pop-in relative">
            <button id="story-reveal-close-btn" class="absolute top-4 right-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            <p id="story-reveal-text" class="text-4xl md:text-5xl text-center leading-relaxed font-serif text-gray-800"></p>
        </div>
    </div>
    
    <!-- v5.5.0 REVAMPED MODAL: Story History -->
    <div id="story-history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-5xl w-full pop-in border-4 border-cyan-300 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="story-history-title" class="font-title text-2xl md:text-3xl text-cyan-700">Story Chronicle</h2>
                <button id="story-history-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="story-history-content" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 flex-grow"></div>
        </div>
    </div>

    <!-- v5.5.4 NEW MODAL: Story Archive -->
    <div id="story-archive-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-3xl w-full pop-in border-4 border-indigo-300 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-title text-2xl md:text-3xl text-indigo-700">Completed Storybook Archive</h2>
                <button id="story-archive-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="story-archive-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 flex-grow bg-gray-50 rounded-lg"></div>
        </div>
    </div>

    <!-- v5.5.4 NEW MODAL: Storybook Viewer -->
    <div id="storybook-viewer-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-5xl w-full pop-in border-4 border-purple-300 flex flex-col">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-grow">
                    <h2 id="storybook-viewer-title" class="font-title text-2xl md:text-3xl text-purple-700"></h2>
                    <p id="storybook-viewer-subtitle" class="text-sm text-gray-500 -mt-1"></p>
                </div>
                <button id="storybook-viewer-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button flex-shrink-0">&times;</button>
            </div>
            <div id="storybook-viewer-content" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 flex-grow bg-gray-50 p-4 rounded-lg"></div>
            <div class="flex gap-2 mt-4">
                <button id="storybook-viewer-play-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-title text-lg py-3 rounded-xl bubbly-button">
                    <i class="fas fa-play-circle mr-2"></i> Narrate Story
                </button>
                <button id="storybook-viewer-print-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-title text-lg py-3 rounded-xl bubbly-button">
                    <i class="fas fa-print mr-2"></i> Print Storybook
                </button>
                <button id="storybook-viewer-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-title text-lg py-3 px-5 rounded-xl bubbly-button">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    </div>


    <!-- v5.5.0 NEW MODALS (Replacing prompts) -->
    <div id="edit-student-name-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full pop-in border-4 border-cyan-300">
            <h2 class="font-title text-2xl text-cyan-700 mb-4 text-center">Edit Student Name</h2>
            <input type="hidden" id="edit-student-id-input">
            <div class="mb-4">
                <label for="edit-student-name-input" class="block text-sm font-medium text-gray-700">New Name</label>
                <input type="text" id="edit-student-name-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" required>
            </div>
            <div class="flex justify-around gap-4 mt-6">
                <button id="edit-student-name-cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 px-8 rounded-xl bubbly-button">Cancel</button>
                <button id="edit-student-name-confirm-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-title text-lg py-2 px-8 rounded-xl bubbly-button">Save</button>
            </div>
        </div>
    </div>

    <!-- v5.5.2 NEW MODAL for Award Log Notes -->
    <div id="award-note-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full pop-in border-4 border-blue-300">
            <h2 class="font-title text-2xl text-blue-700 mb-4 text-center">Teacher's Note for Award</h2>
            <input type="hidden" id="award-note-log-id-input">
            <div class="mb-4">
                <label for="award-note-textarea" class="block text-sm font-medium text-gray-700">Your personal note for this award:</label>
                <textarea id="award-note-textarea" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div class="flex justify-around gap-4 mt-6">
                <button id="award-note-cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 px-8 rounded-xl bubbly-button">Cancel</button>
                <button id="award-note-confirm-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-title text-lg py-2 px-8 rounded-xl bubbly-button">Save Note</button>
            </div>
        </div>
    </div>

    <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full pop-in border-4 border-blue-300">
            <h2 class="font-title text-2xl text-blue-700 mb-4 text-center">Teacher's Note for Adventure Log</h2>
            <input type="hidden" id="note-log-id-input">
            <div class="mb-4">
                <label for="note-textarea" class="block text-sm font-medium text-gray-700">Your personal note for this day's log:</label>
                <textarea id="note-textarea" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div class="flex justify-around gap-4 mt-6">
                <button id="note-cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 px-8 rounded-xl bubbly-button">Cancel</button>
                <button id="note-confirm-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-title text-lg py-2 px-8 rounded-xl bubbly-button">Save Note</button>
            </div>
        </div>
    </div>

    <div id="story-input-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-lg w-full pop-in border-4 border-cyan-300">
            <h2 class="font-title text-2xl text-cyan-700 mb-4 text-center">Continue the Chronicle</h2>
            <div class="mb-4">
                <label for="story-input-textarea" class="block text-sm font-medium text-gray-700">Enter the new, complete story sentence:</label>
                <textarea id="story-input-textarea" rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500"></textarea>
            </div>
            <div class="flex justify-around gap-4 mt-6">
                <button id="story-input-cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 px-8 rounded-xl bubbly-button">Cancel</button>
                <button id="story-input-confirm-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-title text-lg py-2 px-8 rounded-xl bubbly-button">Save Sentence</button>
            </div>
        </div>
    </div>

    <div id="quest-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-xl w-full pop-in border-4 border-indigo-300">
            <h2 class="font-title text-2xl text-indigo-700 mb-4 text-center flex items-center justify-center gap-2"><i class="fas fa-scroll"></i> Quest Assignment</h2>
            <input type="hidden" id="quest-assignment-class-id">
            
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border-l-4 border-gray-300">
                <h3 class="text-sm font-bold text-gray-600">Previous Assignment:</h3>
                <p id="previous-assignment-text" class="text-gray-800 italic mt-1 min-h-[40px]"></p>
            </div>

            <div class="mb-4">
                <label for="quest-assignment-textarea" class="block text-sm font-bold text-gray-700 mb-2">Assignment for Next Lesson:</label>
                <textarea id="quest-assignment-textarea" rows="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div class="flex justify-around gap-4 mt-6">
                <button id="quest-assignment-cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 px-8 rounded-xl bubbly-button">Close</button>
                <button id="quest-assignment-confirm-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-title text-lg py-2 px-8 rounded-xl bubbly-button">Save Assignment</button>
            </div>
        </div>
    </div>

    <!-- REVAMPED: TRIAL TYPE SELECTOR MODAL -->
    <div id="trial-type-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-2xl w-full pop-in border-4 border-amber-300 text-center">
            <h2 class="font-title text-4xl text-amber-800 mb-2">Choose Your Challenge</h2>
            <p class="text-gray-600 mb-8">What kind of trial are we logging today?</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button id="select-dictation-btn" class="flex flex-col items-center justify-center p-8 rounded-2xl border-4 border-blue-200 bg-blue-50 hover:bg-blue-100 hover:border-blue-400 hover:shadow-xl transition-all duration-200 bubbly-button group">
                    <i class="fas fa-microphone-alt text-6xl text-blue-400 mb-4 group-hover:text-blue-600 group-hover:scale-110 transition-transform"></i>
                    <span class="font-title text-3xl text-blue-800">Dictation</span>
                </button>
                
                <button id="select-test-btn" class="flex flex-col items-center justify-center p-8 rounded-2xl border-4 border-green-200 bg-green-50 hover:bg-green-100 hover:border-green-400 hover:shadow-xl transition-all duration-200 bubbly-button group">
                    <i class="fas fa-file-alt text-6xl text-green-400 mb-4 group-hover:text-green-600 group-hover:scale-110 transition-transform"></i>
                    <span class="font-title text-3xl text-green-800">Test</span>
                </button>
            </div>
            
            <button id="trial-type-cancel-btn" class="mt-8 text-gray-500 hover:text-gray-800 font-semibold underline">Cancel</button>
        </div>
    </div>

    <!-- REVAMPED: BULK LOG MODAL -->
    <div id="bulk-trial-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[73] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl shadow-2xl max-w-5xl w-full h-[90vh] flex flex-col pop-in border-4 border-amber-300 overflow-hidden">
            
            <!-- Header -->
            <div class="bg-amber-50 p-6 border-b-2 border-amber-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 id="bulk-trial-title" class="font-title text-3xl text-amber-800">Log Results</h2>
                    <p id="bulk-trial-subtitle" class="text-amber-600 font-semibold"></p>
                </div>
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Date</label>
                        <input type="date" id="bulk-trial-date" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 outline-none">
                    </div>
                    <div id="bulk-trial-title-wrapper" class="hidden">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Title</label>
                        <input type="text" id="bulk-trial-name" placeholder="e.g. Unit 5 Quiz" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 outline-none w-48 md:w-64">
                    </div>
                    <button id="bulk-trial-save-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-title text-xl py-2 px-8 rounded-xl bubbly-button shadow-md">
                        <i class="fas fa-save mr-2"></i> Save All
                    </button>
                </div>
            </div>
            
            <!-- Student List (Scrollable) -->
            <div class="flex-grow overflow-y-auto p-6 bg-gray-50">
                <div id="bulk-student-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Student Rows injected here -->
                </div>
            </div>
            
            <!-- Footer -->
            <div class="p-4 border-t border-gray-200 bg-white flex justify-between items-center">
                <span class="text-xs text-gray-400">Prodigies Language School</span>
                <button id="bulk-trial-close-btn" class="text-gray-500 hover:text-red-500 font-bold px-4">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Starfall Modal (UPDATED for Batch Support) -->
    <div id="starfall-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4 hidden">
        <div id="starfall-modal-content" class="relative text-center p-8 rounded-3xl shadow-2xl max-w-lg w-full pop-in overflow-hidden">
            <div class="absolute -top-1/2 -left-1/2 w-[200%] h-[200%] starfall-bg"></div>
            <div class="relative z-10">
                <div id="starfall-icon" class="text-7xl mb-4 starfall-icon-animate">‚≠ê</div>
                <h2 class="font-title text-4xl text-white mb-4" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">A Starfall Opportunity!</h2>
                
                <!-- Single View Container -->
                <div id="starfall-single-view">
                    <p id="starfall-message" class="text-white/90 text-lg leading-relaxed mb-6" style="text-shadow: 0 1px 3px rgba(0,0,0,0.3);">The stars have noticed <b id="starfall-student-name" class="text-yellow-200">Student Name's</b> incredible effort on their trial! Their brilliance has caused a star to fall from the sky.</p>
                </div>

                <!-- Batch View Container (Hidden by default) -->
                <div id="starfall-batch-view" class="hidden mb-6">
                    <p class="text-white/90 text-lg leading-relaxed mb-4" style="text-shadow: 0 1px 3px rgba(0,0,0,0.3);">The stars are raining down! These scholars have triggered a Starfall Bonus!</p>
                    <div id="starfall-batch-list" class="bg-white/20 backdrop-blur-sm rounded-xl p-2 max-h-40 overflow-y-auto text-left space-y-1">
                        <!-- List items injected via JS -->
                    </div>
                </div>

                <p class="text-white font-bold text-xl mb-6">Shall we bestow these Bonus Stars?</p>
                <div class="flex flex-col items-center gap-3">
                    <button id="starfall-confirm-btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-title text-xl py-3 rounded-xl bubbly-button shadow-lg border-b-4 border-yellow-600">Yes, Bestow Bonus Stars! ‚ú®</button>
                    <button id="starfall-cancel-btn" class="text-white/70 hover:text-white hover:underline">Not This Time</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Attendance Chronicle Modal -->
    <div id="attendance-chronicle-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-4xl w-full pop-in border-4 border-gray-300 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="attendance-chronicle-title" class="font-title text-2xl md:text-3xl text-gray-700">Attendance Chronicle</h2>
                <button id="attendance-chronicle-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="attendance-chronicle-content" class="space-y-4 max-h-[70vh] overflow-y-auto overflow-x-auto pr-2"></div>
        </div>
    </div>

    <!-- Trial History Modal -->
    <div id="trial-history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-gradient-to-br from-amber-50 to-orange-100 p-6 md:p-8 rounded-3xl shadow-2xl max-w-4xl w-full pop-in border-4 border-amber-300 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="trial-history-title" class="font-title text-2xl md:text-3xl text-amber-800">Trial History</h2>
                <button id="trial-history-close-btn" class="bg-amber-200 hover:bg-amber-300 text-amber-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <!-- NEW: Controls Container -->
            <div id="trial-history-controls-container" class="flex justify-between items-center mb-4">
                <!-- This will be populated by JS -->
            </div>
            <div id="trial-history-content" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 flex-grow bg-white/30 rounded-lg">
                <!-- History items will be inserted here by JS -->
            </div>
        </div>
    </div>
    
    <!-- Hidden Templates for Printing -->
    <div style="position: fixed; left: -9999px; top: -9999px;">
        <div id="certificate-template">
             <div style="display: flex; flex-direction: column; height: 100%; width: 100%; align-items: center; text-align: center; position: relative;">
                
                
                <!-- Top Section -->
                <div>
                    <div id="cert-icon" style="font-size: 70px; line-height: 1; margin-bottom: 5px;"></div>
                    <h1 id="cert-title" style="font-family: 'Fredoka One', cursive; font-size: 44px; margin: 0;">Certificate of Achievement</h1>
                    <p style="font-size: 22px; margin-top: 5px;">PROUDLY PRESENTED TO</p>
                </div>

                <!-- Middle Section (Grows) -->
                <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; width: 100%;">
                    <p id="cert-student-name" style="font-family: 'Fredoka One', cursive; font-size: 56px; margin: 10px 0;"></p>
                    <div id="cert-text" style="font-size: 21px; margin: 10px auto; max-width: 90%;">
                        Certificate text will be generated here.
                    </div>
                </div>

                <!-- Bottom Section -->
                <div style="width: 100%; margin-top: auto; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="text-align: center;">
                            <p style="border-top-width: 2px; border-top-style: solid; padding-top: 5px; font-weight: bold;" id="cert-teacher-name">Teacher Name</p>
                            <p style="font-size: 14px; margin-top: 5px;">Quest Facilitator</p>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 15px;">
                            <div style="text-align: center;">
                                <p style="border-top-width: 2px; border-top-style: solid; padding-top: 5px; font-weight: bold;" id="cert-date">Date</p>
                                <p style="font-size: 14px; margin-top: 5px;">Date of Issue</p>
                            </div>
                            <img id="cert-avatar" src="" style="display: none; width: 60px; height: 60px; border-radius: 9999px; border: 4px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #888; margin-top: 15px; text-align: center; width: 100%;">Prodigies Language School</p>
                </div>

            </div>
        </div>
        <div id="storybook-print-container" style="width: 800px;"></div>
        <div id="storybook-signature-page-template" style="width: 800px; height: 600px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; background-color: #F3E8FF; border: 10px solid #A855F7; box-sizing: border-box;">
            <div id="signature-class-logo" style="font-size: 100px; margin-bottom: 20px;"></div>
            <h2 id="signature-created-by" style="font-family: 'Fredoka One', cursive; font-size: 40px; color: #5B21B6; text-align: center;">Created By The Adventurers Of</h2>
            <h1 id="signature-class-name" style="font-family: 'Fredoka One', cursive; font-size: 50px; color: #3730A3; text-align: center; margin-bottom: 20px;"></h1>
            <div id="signature-student-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 5px 15px; font-family: 'Georgia', serif; font-size: 18px; color: #4C1D95;">
                <!-- Student names will be injected here -->
            </div>
            <p id="signature-school-name" style="font-size: 14px; color: #6D28D9; margin-top: auto;">Prodigies Language School</p>
        </div>
    </div>

    <!-- OVERVIEW MODAL -->
    <div id="overview-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[71] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-4xl w-full pop-in border-4 border-purple-300 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="overview-modal-title" class="font-title text-2xl md:text-3xl text-purple-700">Quest Overview</h2>
                <button id="overview-modal-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            
            <!-- Modal Tabs -->
            <div class="border-b border-gray-200 mb-4">
                <nav id="overview-modal-tabs" class="-mb-px flex space-x-6">
                    <button data-view="class" class="overview-tab-btn whitespace-nowrap py-3 px-1 border-b-4 font-semibold text-lg border-purple-500 text-purple-600">
                        <i class="fas fa-users mr-2"></i>Class Overview
                    </button>
                    <button data-view="student" class="overview-tab-btn whitespace-nowrap py-3 px-1 border-b-4 font-semibold text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-user-graduate mr-2"></i>Student Overviews
                    </button>
                </nav>
            </div>

            <div id="overview-modal-content" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>
        
    <!-- Avatar Maker Modal -->
    <div id="avatar-maker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <!-- FIX #2: Increased max-width and added max-height for responsiveness -->
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-5xl w-full pop-in border-4 border-blue-300 flex flex-col md:flex-row gap-6 max-h-[90vh]">
            <!-- Left Side: Options -->
            <div class="flex-1 flex flex-col min-h-0"> <!-- min-h-0 is a flexbox trick to make overflow work correctly -->
                <div class="text-center flex-shrink-0">
                    <h2 class="font-title text-2xl md:text-3xl text-blue-700">Avatar Forge</h2>
                    <p id="avatar-maker-student-name" class="font-semibold text-lg text-gray-600"></p>
                </div>
                
                <!-- FIX #2: Added a scrollable wrapper for the options -->
                <div id="avatar-maker-options-wrapper" class="mt-4 flex-grow space-y-4 overflow-y-auto pr-3">
                    <!-- Creature Pool -->
                    <div class="avatar-maker-option-pool">
                        <h3 class="font-bold text-gray-700 mb-2 text-center">1. Choose a Creature</h3>
                        <div id="avatar-creature-pool" class="flex flex-wrap justify-center gap-2">
                            <!-- Options populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Color Pool -->
                    <div class="avatar-maker-option-pool">
                        <h3 class="font-bold text-gray-700 mb-2 text-center">2. Choose a Main Color</h3>
                        <div id="avatar-color-pool" class="flex flex-wrap justify-center gap-2">
                            <!-- Options populated by JS -->
                        </div>
                    </div>

                    <!-- Accessory Pool -->
                    <div class="avatar-maker-option-pool">
                        <h3 class="font-bold text-gray-700 mb-2 text-center">3. Choose an Accessory</h3>
                        <div id="avatar-accessory-pool" class="flex flex-wrap justify-center gap-2">
                            <!-- Options populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Display & Actions -->
            <div class="md:w-1/3 flex flex-col items-center justify-between">
                <div id="avatar-display-area" class="mb-4">
                    <div id="avatar-maker-placeholder" class="text-center text-gray-500 p-4">
                        <i class="fas fa-magic text-4xl"></i>
                        <p class="mt-2 font-semibold">Your creation will appear here!</p>
                    </div>
                    <div id="avatar-maker-loader" class="text-center text-gray-500 p-4 hidden">
                        <i class="fas fa-spinner fa-spin text-4xl"></i>
                        <p class="mt-2 font-semibold">Forging avatar...</p>
                    </div>
                    <img id="avatar-maker-img" class="hidden" src="" alt="Generated Avatar">
                </div>

                <div class="w-full space-y-2">
                    <button id="avatar-generate-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-title text-xl py-3 rounded-xl bubbly-button disabled:opacity-50" disabled>
                        <i class="fas fa-magic mr-2"></i> Generate
                    </button>
                    <div id="avatar-post-generation-btns" class="hidden w-full space-y-2">
                        <button id="avatar-save-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-title text-xl py-3 rounded-xl bubbly-button">
                        <i class="fas fa-save mr-2"></i> Save Avatar
                    </button>
                    <button id="avatar-retry-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-title text-lg py-2 rounded-xl bubbly-button">
                        <i class="fas fa-redo mr-2"></i> Try Again
                    </button>
                </div>
                <button id="avatar-delete-btn" class="w-full bg-red-100 text-red-700 font-semibold text-sm py-2 rounded-lg mt-2 bubbly-button hidden">
                    <i class="fas fa-trash-alt mr-2"></i> Remove Avatar
                </button>
                <button id="avatar-maker-close-btn" class="w-full text-sm text-gray-600 hover:underline mt-2">Close</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Move Student Modal -->
    <div id="move-student-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full pop-in border-4 border-yellow-300">
            <h2 class="font-title text-2xl text-yellow-800 mb-4 text-center">Move Student</h2>
            <p class="text-center mb-2">Moving: <b id="move-student-name" class="text-lg"></b></p>
            <p class="text-center text-sm text-gray-600 mb-6">From: <span id="move-student-current-class"></span></p>
            <div class="mb-4">
                <label for="move-student-target-class" class="block text-sm font-medium text-gray-700">Select new class (must be in the same league):</label>
                <select id="move-student-target-class" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500"></select>
            </div>
            <div class="flex justify-around gap-4 mt-6">
                <button id="move-student-cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-title text-lg py-2 px-8 rounded-xl bubbly-button">Cancel</button>
                <button id="move-student-confirm-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-title text-lg py-2 px-8 rounded-xl bubbly-button">Confirm Move</button>
            </div>
        </div>
    </div>

    <!-- Hero Stats Modal -->
    <div id="hero-stats-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <!-- MODIFIED: Increased max-width from 2xl to 4xl -->
        <div class="bg-gradient-to-br from-gray-800 via-purple-900 to-gray-900 p-6 rounded-3xl shadow-2xl max-w-4xl w-full pop-in border-4 border-purple-400 flex flex-col md:flex-row gap-6 relative">
            <button id="hero-stats-close-btn" class="absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 text-white font-bold w-10 h-10 rounded-full bubbly-button z-10">&times;</button>
            
            <!-- Left Side: Avatar -->
            <div id="hero-stats-avatar-container" class="md:w-1/3 flex flex-col items-center justify-center text-center text-white">
                <div id="hero-stats-avatar" class="w-48 h-48 rounded-full border-4 border-purple-300 shadow-lg mb-4">
                    <!-- Avatar img or div will be injected here -->
                </div>
                <h2 id="hero-stats-name" class="font-title text-3xl" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);"></h2>
            </div>

            <!-- Right Side: Stats -->
            <div class="flex-grow flex flex-col">
                <div id="hero-stats-content" class="space-y-3">
                    <!-- Stats will be injected here -->
                </div>
                <!-- NEW: Chart Container -->
                <div id="hero-stats-chart-container" class="mt-4 flex-grow">
                    <!-- Chart will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Ceremony Screen -->
    <div id="ceremony-screen" class="fixed inset-0 z-[90] flex items-center justify-center hidden">
        <!-- The Veil -->
        <div id="ceremony-veil" class="absolute inset-0 bg-gradient-to-br from-sky-200/80 via-purple-200/80 to-amber-200/80 backdrop-blur-md flex items-center justify-center p-4">
            <button id="ceremony-veil-close-btn" class="absolute top-4 right-4 text-white/70 hover:text-white text-4xl z-10" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">&times;</button>
            <button id="start-ceremony-btn" class="text-center transform transition hover:scale-105">
                <div id="ceremony-month-name" class="font-title text-5xl text-white" style="text-shadow: 0 3px 5px rgba(0,0,0,0.2);"></div>
                <div class="mt-2 px-8 py-4 bg-gradient-to-r rounded-full shadow-2xl">
                    <span class="font-title text-6xl text-white tracking-wider" style="text-shadow: 0 4px 6px rgba(0,0,0,0.3);">Award Ceremony</span>
                </div>
            </button>
        </div>

        <!-- The Main Stage -->
        <div id="ceremony-stage" class="absolute inset-0 bg-gray-900 text-white p-8 flex flex-col items-center justify-center hidden">
            <div id="ceremony-title" class="font-title text-4xl mb-4 text-center"></div>
            
            <div id="ceremony-reveal-area" class="flex-grow w-full flex items-center justify-center relative overflow-hidden">
                <!-- Cards will be injected here -->
            </div>

            <div id="ceremony-ai-commentary" class="w-full max-w-3xl h-24 mt-4 bg-black/30 rounded-lg p-4 text-center text-xl italic flex items-center justify-center">
                <p>The Quest Master is preparing their scroll...</p>
            </div>

            <div class="mt-4 flex items-center justify-between w-full max-w-4xl">
                <button id="ceremony-exit-btn" class="text-gray-400 hover:text-white">Exit Ceremony</button>
                <button id="ceremony-show-global-btn" class="hidden bg-blue-500 hover:bg-blue-600 font-bold text-lg py-2 px-6 rounded-full bubbly-button">
                <i class="fas fa-globe-americas mr-2"></i> Show Global Ranks</button>
                <button id="ceremony-next-btn" class="bg-green-500 hover:bg-green-600 font-bold text-2xl w-16 h-16 rounded-full bubbly-button flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                <button id="ceremony-skip-btn" class="text-gray-400 hover:text-white">Skip to End</button>
            </div>
        </div>
    </div>

    <!-- Global Leaderboard Modal -->
    <div id="global-leaderboard-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[95] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-lg w-full pop-in border-4 border-purple-300 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="global-leaderboard-title" class="font-title text-2xl md:text-3xl text-purple-700">Global Leaderboard</h2>
                <button id="global-leaderboard-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button">&times;</button>
            </div>
            <div id="global-leaderboard-content" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Leaderboard items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Hero Chronicle Modal -->
    <div id="hero-chronicle-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[72] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-6xl w-full pop-in border-4 border-green-300 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-4 flex-shrink-0">
                <div>
                    <h2 id="hero-chronicle-title" class="font-title text-2xl md:text-3xl text-green-700">Hero's Chronicle</h2>
                    <p id="hero-chronicle-student-name" class="font-semibold text-lg text-gray-600 -mt-1"></p>
                </div>
                <button id="hero-chronicle-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-10 h-10 rounded-full bubbly-button flex-shrink-0">&times;</button>
            </div>
    
            <div class="flex flex-col md:flex-row gap-6 min-h-0">
                <!-- Left Column: Notes -->
                <div class="md:w-1/2 flex flex-col min-h-0">
                    <h3 class="font-title text-xl text-gray-700 mb-2 flex-shrink-0">Teacher's Logbook</h3>
                    <div id="hero-chronicle-notes-feed" class="flex-grow space-y-3 overflow-y-auto pr-2 bg-gray-50 p-3 rounded-lg border">
                        <!-- Notes will be injected here -->
                    </div>
                    <form id="hero-chronicle-note-form" class="mt-4 pt-4 border-t flex-shrink-0">
                        <input type="hidden" id="hero-chronicle-note-id">
                        <div class="flex items-center gap-2 mb-2">
                            <label for="hero-chronicle-note-category" class="font-semibold text-sm">Category:</label>
                            <select id="hero-chronicle-note-category" class="flex-grow border border-gray-300 rounded-md px-2 py-1 text-sm">
                                <option>General</option>
                                <option>Behavior</option>
                                <option>Academic</option>
                                <option>Social</option>
                            </select>
                        </div>
                        <textarea id="hero-chronicle-note-text" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Add a new note..."></textarea>
                        <div class="flex items-center gap-2 mt-2">
                            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-title py-2 rounded-lg bubbly-button">Save Note</button>
                            <button type="button" id="hero-chronicle-cancel-edit-btn" class="hidden w-full bg-gray-200 text-gray-700 font-title py-2 rounded-lg bubbly-button">Cancel Edit</button>
                        </div>
                    </form>
                </div>
    
                <!-- Right Column: AI Insights -->
                <div class="md:w-1/2 flex flex-col">
                    <h3 class="font-title text-xl text-indigo-700 mb-2">The Oracle's Counsel</h3>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button data-type="parent" class="ai-insight-btn bg-indigo-100 text-indigo-800 p-2 rounded-lg bubbly-button text-sm font-semibold"><i class="fas fa-user-friends mr-1"></i> Parent Summary</button>
                        <button data-type="teacher" class="ai-insight-btn bg-indigo-100 text-indigo-800 p-2 rounded-lg bubbly-button text-sm font-semibold"><i class="fas fa-chalkboard-teacher mr-1"></i> Teacher Strategy</button>
                        <button data-type="analysis" class="ai-insight-btn bg-indigo-100 text-indigo-800 p-2 rounded-lg bubbly-button text-sm font-semibold"><i class="fas fa-chart-pie mr-1"></i> Strengths/Weaknesses</button>
                        <button data-type="goal" class="ai-insight-btn bg-indigo-100 text-indigo-800 p-2 rounded-lg bubbly-button text-sm font-semibold"><i class="fas fa-bullseye mr-1"></i> Goal Suggestion</button>
                    </div>
                    <div id="hero-chronicle-ai-output" class="flex-grow bg-indigo-50 p-4 rounded-lg border border-indigo-200 overflow-y-auto">
                        <p class="text-center text-indigo-700">Select a counsel type to receive the Oracle's wisdom.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link to your external JavaScript file -->
    <script type="module" src="app.js"></script>
</body>
</html>
